{% extends "base.html" %}
{% block title %}Результат{% endblock %}
{% block content %}
  <section class="result">
    <h2>Результат анализа</h2>
    {% if not data.result %}
      <p>Результат не найден или истёк.</p>
    {% else %}
      <div class="result-layout">
        <aside>
          <h3>События</h3>
          <ol class="event-list">
            {% for item in data.result.items %}
              <li>
                <button class="event-button{% if forloop.first %} active{% endif %}" data-target="event-{{ forloop.counter0 }}">
                  {{ forloop.counter }}. {{ item.extracted.raw_text|truncatechars:80 }}
                </button>
                {% if item.event_found %}
                  <span class="status status-plus">✓</span>
                {% endif %}
              </li>
            {% endfor %}
          </ol>
          <a class="button" href="/jobs/{{ job_id }}/clear">Очистить</a>
        </aside>
        <div class="result-details">
          {% for item in data.result.items %}
            <article id="event-{{ forloop.counter0 }}" class="event-detail{% if forloop.first %} active{% endif %}">
              <h4>Событие {{ forloop.counter }}</h4>
              <p class="event-text">{{ item.highlighted_text|safe }}</p>
              {% if item.message %}<p class="warning">{{ item.message }}</p>{% endif %}
              <table class="attributes-table">
                <tbody>
                  {% for key, attr in item.attributes.items %}
                    {% if attr.value %}
                      <tr>
                        <td class="attr-name">{{ key }}</td>
                        <td>
                          {% if attr.status %}
                            {% if attr.status == "+" %}
                              <span class="status status-plus">+</span>
                            {% elif attr.status == "!" %}
                              <span class="status status-warn">!</span>
                            {% else %}
                              <span class="status status-fail">-</span>
                            {% endif %}
                          {% endif %}
                          {% if key == "timestamp" %}
                            {% if attr.timestamp_delta_human %}
                              <span class="attr-percent">Δ {{ attr.timestamp_delta_human }}</span>
                            {% endif %}
                          {% elif attr.percent is not None %}
                            <span class="attr-percent">{{ attr.percent }}%</span>
                          {% endif %}
                        </td>
                        <td class="value">{{ attr.value }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
              {% if item.event_type %}
                <div class="event-type-block">
                  <h5>Тип события</h5>
                  <ul>
                    <li>
                      Определено:
                      {% if item.event_type.detected %}
                        {{ item.event_type.detected }}
                        {% if item.event_type.detected_score %}
                          (score {{ item.event_type.detected_score }})
                        {% endif %}
                      {% else %}
                        не удалось идентифицировать
                      {% endif %}
                    </li>
                    <li>
                      В БД:
                      {{ item.event_type.stored|default:"не задан" }}
                    </li>
                    <li>{{ item.event_type.message }}</li>
                  </ul>
                </div>
              {% endif %}
              {% if item.event_found %}
                <div class="portal-block">
                  <h5>Найденная запись в БД</h5>
                  {% if item.match_lines %}
                    <ul>
                      {% for line in item.match_lines %}
                        <li>{{ line }}</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                  {% for match in item.matches %}
                    <div class="portal-record">
                      <div>Запись {{ forloop.counter }}</div>
                      <div>event_id: {{ match.event_id }}</div>
                      <div>Время: {{ match.date_detection }}</div>
                      <div>
                        Подразделение:
                        {{ match.subdivision_short_name|default:match.subdivision_name }}
                        ({{ match.subdivision_full_name|default:match.subdivision_name }})
                      </div>
                      {% if match.event_type_name %}
                        <div>Тип события (БД): {{ match.event_type_name }}</div>
                      {% endif %}
                      <div>Нарушители: {{ match.offenders|join:", " }}</div>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
              {% if item.notes %}
                <div class="diff-block">
                  <ul>
                    {% for line in item.notes %}
                      <li>{{ line }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            </article>
          {% endfor %}
        </div>
      </div>
      <script>
        const buttons = document.querySelectorAll('.event-button');
        const details = document.querySelectorAll('.event-detail');
        function selectEvent(targetId) {
          details.forEach((detail) => detail.classList.toggle('active', detail.id === targetId));
          buttons.forEach((button) =>
            button.classList.toggle('active', button.dataset.target === targetId)
          );
        }
        buttons.forEach((button) => {
          button.addEventListener('click', () => selectEvent(button.dataset.target));
        });
        if (buttons.length) {
          selectEvent(buttons[0].dataset.target);
        }
      </script>
    {% endif %}
  </section>
{% endblock %}
