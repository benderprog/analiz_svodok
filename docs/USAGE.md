# Руководство пользователя (оператор)

Документ описывает работу в UI и расположение файлов в релизе/контейнере.

## Где лежат файлы
- `fixtures/` — тестовые файлы (на хосте рядом с `docker-compose.offline.yml`).
- `artifacts/` — результаты обработки (на хосте; в контейнере `/data/artifacts`).
- `seed/` — SQL-инициализация тестовой БД портала.
- `models/hf/` — локальный кэш модели (если сборка в режиме `MODEL_CACHE_MODE=local`).

## Роли и вход
- Роли **admin** и **operator** сейчас одинаковы по правам.
- Вход выполняется через страницу `/login` с учётной записью из `.env`
  (`APP_ADMIN_LOGIN` / `APP_ADMIN_PASSWORD`).

## Экран Upload (загрузка)
- Загружается только файл формата **DOCX**.
- **Один абзац = одно событие.** Каждая строка/абзац анализируется отдельно.
- После выбора файла нажмите **«Анализировать справку»**.

## Что происходит после «Анализировать справку»
1) Файл сохраняется и ставится в очередь.
2) Задача уходит в **Celery** (асинхронная обработка).
3) Выполняется извлечение атрибутов и поиск кандидатов в БД портала.
4) Результат сравнения сохраняется и отображается в UI.

## Экран Result (результаты)
Слева — список событий (абзацев). Справа — детали выбранного события.

### Таблица атрибутов и статусы
**Timestamp**
- Формат отображения: `YYYY-MM-DD HH:MM`.
- Если время найдено, сравнение идёт с точностью до **±10 минут** (по умолчанию).
- Статусы:
  - `+` — время совпало точно.
  - `!` — время попало в окно ±30 минут, отображается дельта: `+ Δ X мин`.
  - `-` — время найдено, но совпадения нет.
  - `! (время отсутствует)` — дата есть, времени нет.

**Subdivision**
- Определяется по семантическому совпадению.
- Показывается процент совпадения.
- Статусы:
  - `+` — подразделение совпало.
  - `!` — совпадение частичное (есть близкий вариант).
  - `-` или `не определено` — совпадение ниже порога.

**Offenders**
- Сравнение по множеству нарушителей (ФИО + дата рождения/год рождения).
- Поддерживаемые форматы ДР рядом с ФИО:
  - `дд.мм.гггг` (допускаются `.` и `-`, возможны скобки/запятые),
  - `гггг` только с маркерами `г`, `г.`, `г.р.`, `г р`, `года`, `года рождения`.
- Статусы:
  - `+` — полный набор совпал.
  - `!` — частичное совпадение.
  - `-` — совпадений нет.

### Блок «Найденная запись в БД»
Заполняется, если событие найдено по правилу **«2 из 3»**:
- время,
- подразделение,
- нарушители (не обязательны среди совпавших двух; ошибки БД по нарушителям не блокируют матч).

### Типы событий
В системе используется справочник **типов событий** и **паттернов событий**.
Паттерны сопоставляются с текстом абзаца с помощью семантической модели.

В результате анализа отображаются:
- **Определённый тип события** (или статус «не удалось идентифицировать»).
- **Тип события из БД** (если задан для найденной записи).
- Статус сравнения:
  - совпадает,
  - в БД не задан (определён автоматически),
  - в БД задан, но не подтверждён автоматически,
  - несовпадение.

Порог определения настраивается через `EVENT_TYPE_MATCH_THRESHOLD`.

## Справочник подразделений
Справочник хранится в БД приложения (модель `SubdivisionRef`) и загружается
из YAML-файла `configs/divisions.yaml`.

Для синхронизации используйте команду:
```bash
python manage.py sync_divisions --file configs/divisions.yaml
```

## Тестовые подразделения с населёнными пунктами
В тестовой конфигурации подразделения оформлены в формате
`<тип> №<номер/название> (<населённый пункт>)` и включают реальные варианты
написания (включая алиасы вроде `ПЗ1`). После синхронизации справочника они
используются для семантического матчинга в UI и в тестовой БД портала.

Команды для наполнения данных:
```bash
python manage.py sync_divisions --file configs/divisions.yaml
./scripts/closed/seed.sh
```
`seed.sh` поднимает локальные сервисы, выполняет миграции приложения и
заполняет тестовые данные как в БД приложения, так и в БД портала.

Если портал развёрнут локально без Docker, используйте:
```bash
./scripts/seed_local_portal.sh
```
Скрипт применяет `seed/portal_schema.sql`, а затем наполняет БД портала
данными из DOCX (если есть `fixtures/test_svodka_semantic3.docx` или любой
`fixtures/*.docx`) либо из `seed/portal_data.sql`.
Для локальных настроек скрипт сначала читает `.env.local` (если есть), затем `.env`.

### Локальное наполнение портальной БД
Пример полного цикла с очисткой схемы и проверкой:
```bash
source .env.local
./scripts/seed_local_portal.sh --reset
./scripts/verify_local_portal.sh
```

Все идентификаторы в тестовой портальной БД — **UUID** (включая `subdivision.id`,
`events.id` и `offenders.id`). В `seed/portal_data.sql` используются фиксированные UUID
для детерминированных прогонов.

Ожидаемый результат — успешный матчинг по примерам:
```text
службой ПОГЗ №2 (с. Васильки) выявлены...
на посту ОПК Центральное (г. Южный)...
службой ПЗ1 ...
```

Пример проверки в интерактивной оболочке:
```bash
python manage.py shell
from apps.analysis.services.semantic import SubdivisionSemanticService
svc = SubdivisionSemanticService("sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2")
svc.match("службой ПОГЗ №2 в с. Васильки ...")
```

## Типовые ошибки и что делать
- **Не определилось подразделение**
  - Проверьте, что подразделение явно указано в тексте.
  - Убедитесь, что в справочнике подразделений есть нужная запись.
- **Не извлеклись нарушители**
  - ФИО должны быть в формате «Фамилия Имя Отчество».
  - Дата рождения поддерживается как `дд.мм.гггг` или `1991 г.р.` (год без маркера не извлекается).
- **Найдено несколько записей**
  - В портальной БД есть дубликаты по правилу «2 из 3».
  - Проверьте записи в БД портала и критерии сравнения.
- **Ошибка подключения к БД портала**
  - Проверьте параметры `PORTAL_*` в `.env`.
- **Задача зависла/нет результатов**
  - Проверьте, что запущены `redis` и `celery` (`./scripts/closed/verify.sh`).
  - Посмотрите логи: `./scripts/closed/logs.sh`.

## Где взять тестовые DOCX
В релизе есть папка `fixtures/` с текстовыми примерами. Для UI нужен DOCX — его можно
сгенерировать:
```bash
docker compose -f docker-compose.offline.yml run --rm web \
  python manage.py make_test_docx --out /data/fixtures/test.docx
```
После генерации используйте `fixtures/test.docx` для загрузки.

## UUID в тестовой БД портала
- В тестовой БД портала все ключевые идентификаторы используют UUID
  (`subdivision.id`, `events.id`, `offenders.id`, а также все FK ссылки).
- В `seed/portal_data.sql` применяются фиксированные UUID для детерминированных прогонов.
