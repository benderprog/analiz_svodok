# NLP пайплайн

## Шаги обработки
1. DOCX разбивается на абзацы (`DocxIngestService`).
2. `ExtractService` на Natasha извлекает:
   - дату/время события (`timestamp`), если время не найдено — сохраняется флаг `timestamp_has_time=False`;
   - нарушителей (ФИО + дата рождения в формате `дд.мм.гггг` или `1991 г.р.`);
   - упоминание подразделения (NER-тип `ORG`).
   Поддерживаются конструкции времени: `В 10.00 31.01.2026 ...` и `31.01.2026 10:00 ...` (форматы времени `10.00` и `10:00`). 
3. `SubdivisionSemanticService` строит эмбеддинги справочника `subdivision_ref` и кэширует их в памяти процесса.
4. `MatchService` ищет кандидатов в портальной БД (точный `timestamp` и окно ±N минут) и применяет правило «2 из 3».
5. `CompareService` формирует статусы, проценты, diff и структуру для UI, результат сохраняется в Redis с TTL 30 минут.

## Допущения/особенности
- Дата рождения связывается с ближайшим упоминанием ФИО в пределах 40 символов.
- Если время отсутствует, атрибут времени помечается как расхождение и не участвует в правиле «2 из 3».
- Подразделение считается определённым только при `similarity >= semantic_threshold_subdivision`.
