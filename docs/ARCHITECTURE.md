# Архитектура

## Общая схема компонентов
- **Django (web)** — UI, авторизация, загрузка DOCX, API прогресса/результатов.
- **Celery worker** — асинхронная обработка DOCX.
- **Redis** — брокер Celery и хранилище результатов (TTL).
- **PostgreSQL (app_db)** — данные приложения, справочники, настройки.
- **PostgreSQL (portal_db, тестовая)** — эмуляция портальной БД в офлайн-стеке.

## Поток обработки
1) Пользователь загружает DOCX через UI.
2) Web сохраняет файл и запускает `analyze_docx` в Celery.
3) Celery:
   - парсит DOCX → абзацы,
   - извлекает атрибуты события,
   - ищет кандидатов в портальной БД,
   - сравнивает атрибуты и формирует результат,
   - сохраняет результат в Redis с TTL.
4) UI опрашивает прогресс и отображает результат.

## Основные модули и ответственность
- `apps/analysis/services/docx_ingest.py`
  - чтение DOCX и разбиение на абзацы.
- `apps/analysis/services/extract.py`
  - извлечение даты/времени, подразделения и нарушителей (NLP/Natasha).
- `apps/analysis/services/semantic.py`
  - эмбеддинги и семантическое сравнение подразделений.
- `apps/analysis/services/match.py`
  - поиск кандидатов и правило «2 из 3».
- `apps/analysis/services/compare.py`
  - вычисление статусов, процентов, diff и подсветки.
- `apps/analysis/services/result_store.py`
  - сохранение/получение результата в Redis.
- `apps/analysis/tasks.py`
  - Celery-задачи.

## Формат результата (JSON)
Результат сериализуется в JSON и ожидается UI:
- `extracted`: исходный текст, индекс абзаца, извлечённые поля.
- `attributes`: статусы и проценты по `timestamp`, `subdivision`, `offenders`.
- `matches`: список найденных кандидатов из портала.
- `found`: найдено ли событие по правилу «2 из 3».

## Правила сравнения
**Timestamp**
- Считается совпавшим, если время совпало точно.
- Допускается окно `±time_window_minutes` (по умолчанию 30) с пометкой `!`.

**Subdivision**
- Семантический матч по справочнику подразделений.
- Совпадение считается валидным при `similarity >= semantic_threshold_subdivision`.

**Offenders**
- Нормализация ФИО, сравнение множеств `ФИО + дата рождения`.
- Частичное совпадение даёт `!` и diff.

## Точки расширения (концептуально)
- Добавление новых атрибутов события (например, место/тип нарушения).
- Поддержка других форматов сводок (PDF, TXT) через новый ingest-сервис.
- Подключение к боевой БД портала без изменения кода через `configs/portal_queries.yaml`.
- Полностью офлайн режим модели через prewarm (сборка с `--prewarm`).
